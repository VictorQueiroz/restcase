(function(root, factory) {
  if (typeof define === 'function' && define.amd) {
    define([], factory);
  } else if (typeof exports === 'object') {
    module.exports = factory();
  } else {
    root.Restcase.min = factory();
  }
}(this, function() {
var Collection=function(t,e){e||(e={}),e.model&&(this.model=e.model),void 0!==e.comparator&&(this.comparator=e.comparator),this._reset(),this.initialize.apply(this,arguments),t&&this.reset(t,_.extend({silent:!0},e))},setOptions={add:!0,remove:!0,merge:!0},addOptions={add:!0,remove:!1};_.extend(Collection.prototype,Events,{model:Model,initialize:function(){},toJSON:function(t){return this.map(function(e){return e.toJSON(t)})},sync:function(){return sync.apply(this,arguments)},add:function(t,e){return this.set(t,_.extend({merge:!1},e,addOptions))},remove:function(t,e){var i=!_.isArray(t);t=i?[t]:_.clone(t),e||(e={});for(var r=0;r<t.length;r++){var s=t[r]=this.get(t[r]);if(s){var n=this.modelId(s.attributes);null!=n&&delete this._byId[n],delete this._byId[s.cid];var o=this.indexOf(s);this.models.splice(o,1),this.length--,e.silent||(e.index=o,s.trigger("remove",s,this,e)),this._removeReference(s,e)}}return i?t[0]:t},set:function(t,e){e=_.defaults({},e,setOptions),e.parse&&(t=this.parse(t,e));var i=!_.isArray(t);t=i?t?[t]:[]:t.slice();var r,s,n,o,l,h=e.at;null!=h&&(h=+h),0>h&&(h+=this.length+1);for(var a=this.comparator&&null==h&&e.sort!==!1,d=_.isString(this.comparator)?this.comparator:null,c=[],u=[],f={},p=e.add,m=e.merge,v=e.remove,g=!a&&p&&v?[]:!1,y=!1,b=0;b<t.length;b++){if(n=t[b],o=this.get(n))v&&(f[o.cid]=!0),m&&n!==o&&(n=this._isModel(n)?n.attributes:n,e.parse&&(n=o.parse(n,e)),o.set(n,e),a&&!l&&o.hasChanged(d)&&(l=!0)),t[b]=o;else if(p){if(s=t[b]=this._prepareModel(n,e),!s)continue;c.push(s),this._addReference(s,e)}s=o||s,s&&(r=this.modelId(s.attributes),!g||!s.isNew()&&f[r]||(g.push(s),y=y||!this.models[b]||s.cid!==this.models[b].cid),f[r]=!0)}if(v){for(var b=0;b<this.length;b++)f[(s=this.models[b]).cid]||u.push(s);u.length&&this.remove(u,e)}if(c.length||y)if(a&&(l=!0),this.length+=c.length,null!=h)for(var b=0;b<c.length;b++)this.models.splice(h+b,0,c[b]);else{g&&(this.models.length=0);for(var x=g||c,b=0;b<x.length;b++)this.models.push(x[b])}if(l&&this.sort({silent:!0}),!e.silent){for(var I=null!=h?_.clone(e):e,b=0;b<c.length;b++)null!=h&&(I.index=h+b),(s=c[b]).trigger("add",s,this,I);(l||y)&&this.trigger("sort",this,e)}return i?t[0]:t},reset:function(t,e){e=e?_.clone(e):{};for(var i=0;i<this.models.length;i++)this._removeReference(this.models[i],e);return e.previousModels=this.models,this._reset(),t=this.add(t,_.extend({silent:!0},e)),e.silent||this.trigger("reset",this,e),t},push:function(t,e){return this.add(t,_.extend({at:this.length},e))},pop:function(t){var e=this.at(this.length-1);return this.remove(e,t),e},unshift:function(t,e){return this.add(t,_.extend({at:0},e))},shift:function(t){var e=this.at(0);return this.remove(e,t),e},slice:function(){return slice.apply(this.models,arguments)},get:function(t){if(null==t)return void 0;var e=this.modelId(this._isModel(t)?t.attributes:t);return this._byId[t]||this._byId[e]||this._byId[t.cid]},at:function(t){return 0>t&&(t+=this.length),this.models[t]},where:function(t,e){var i=_.matches(t);return this[e?"find":"filter"](function(t){return i(t.attributes)})},findWhere:function(t){return this.where(t,!0)},sort:function(t){if(!this.comparator)throw new Error("Cannot sort a set without a comparator");return t||(t={}),_.isString(this.comparator)||1===this.comparator.length?this.models=this.sortBy(this.comparator,this):this.models.sort(_.bind(this.comparator,this)),t.silent||this.trigger("sort",this,t),this},pluck:function(t){return _.invoke(this.models,"get",t)},fetch:function(t){t=t?_.clone(t):{},void 0===t.parse&&(t.parse=!0);var e=t.success,i=this;return t.success=function(r){var s=t.reset?"reset":"set";i[s](r,t),e&&e.call(t.context,i,r,t),i.trigger("sync",i,r,t)},wrapError(this,t),this.sync("read",this,t)},create:function(t,e){e=e?_.clone(e):{};var i=e.wait;if(!(t=this._prepareModel(t,e)))return!1;i||this.add(t,e);var r=this,s=e.success;return e.success=function(t,e,n){i&&r.add(t,n),s&&s.call(n.context,t,e,n)},t.save(null,e),t},parse:function(t,e){return t},clone:function(){return new this.constructor(this.models,{model:this.model,comparator:this.comparator})},modelId:function(t){return t[this.model.prototype.idAttribute||"id"]},_reset:function(){this.length=0,this.models=[],this._byId={}},_prepareModel:function(t,e){if(this._isModel(t))return t.collection||(t.collection=this),t;e=e?_.clone(e):{},e.collection=this;var i=new this.model(t,e);return i.validationError?(this.trigger("invalid",this,i.validationError,e),!1):i},_isModel:function(t){return t instanceof Model},_addReference:function(t,e){this._byId[t.cid]=t;var i=this.modelId(t.attributes);null!=i&&(this._byId[i]=t),t.on("all",this._onModelEvent,this)},_removeReference:function(t,e){this===t.collection&&delete t.collection,t.off("all",this._onModelEvent,this)},_onModelEvent:function(t,e,i,r){if("add"!==t&&"remove"!==t||i===this){if("destroy"===t&&this.remove(e,r),"change"===t){var s=this.modelId(e.previousAttributes()),n=this.modelId(e.attributes);s!==n&&(null!=s&&delete this._byId[s],null!=n&&(this._byId[n]=e))}this.trigger.apply(this,arguments)}}});var collectionMethods={forEach:3,each:3,map:3,collect:3,reduce:4,foldl:4,inject:4,reduceRight:4,foldr:4,find:3,detect:3,filter:3,select:3,reject:3,every:3,all:3,some:3,any:3,include:2,contains:2,invoke:2,max:3,min:3,toArray:1,size:1,first:3,head:3,take:3,initial:3,rest:3,tail:3,drop:3,last:3,without:0,difference:0,indexOf:3,shuffle:1,lastIndexOf:3,isEmpty:1,chain:1,sample:3,partition:3};addUnderscoreMethods(Collection,collectionMethods,"models");var attributeMethods=["groupBy","countBy","sortBy","indexBy"];_.each(attributeMethods,function(t){_[t]&&(Collection.prototype[t]=function(e,i){var r=_.isFunction(e)?e:function(t){return t.get(e)};return _[t](this.models,r,i)})});var extend=function(t,e){var i,r=this;i=t&&_.has(t,"constructor")?t.constructor:function(){return r.apply(this,arguments)},_.extend(i,r,e);var s=function(){this.constructor=i};return s.prototype=r.prototype,i.prototype=new s,t&&_.extend(i.prototype,t),i.__super__=r.prototype,i};
var Events={on:function(t,e,n){if(!eventsApi(this,"on",t,[e,n])||!e)return this;this._events||(this._events={});var i=this._events[t]||(this._events[t]=[]);return i.push({callback:e,context:n,ctx:n||this}),this},once:function(t,e,n){if(!eventsApi(this,"once",t,[e,n])||!e)return this;var i=this,s=_.once(function(){i.off(t,s),e.apply(this,arguments)});return s._callback=e,this.on(t,s,n)},off:function(t,e,n){var i,s,r,c,l,a,o,h;if(!this._events||!eventsApi(this,"off",t,[e,n]))return this;if(!t&&!e&&!n)return this._events=void 0,this;for(c=t?[t]:_.keys(this._events),l=0,a=c.length;a>l;l++)if(t=c[l],r=this._events[t]){if(this._events[t]=i=[],e||n)for(o=0,h=r.length;h>o;o++)s=r[o],(e&&e!==s.callback&&e!==s.callback._callback||n&&n!==s.context)&&i.push(s);i.length||delete this._events[t]}return this},trigger:function(t){if(!this._events)return this;var e=Array.prototype.slice.call(arguments,1);if(!eventsApi(this,"trigger",t,e))return this;var n=this._events[t],i=this._events.all;return n&&triggerEvents(n,e),i&&triggerEvents(i,arguments),this},stopListening:function(t,e,n){var i=this._listeningTo;if(!i)return this;var s=!e&&!n;n||"object"!=typeof e||(n=this),t&&((i={})[t._listenId]=t);for(var r in i)t=i[r],t.off(e,n,this),(s||_.isEmpty(t._events))&&delete this._listeningTo[r];return this}},eventSplitter=/\s+/,eventsApi=function(t,e,n,i){if(!n)return!0;if("object"==typeof n){for(var s in n)t[e].apply(t,[s,n[s]].concat(i));return!1}if(eventSplitter.test(n)){for(var r=n.split(eventSplitter),c=0,l=r.length;l>c;c++)t[e].apply(t,[r[c]].concat(i));return!1}return!0},triggerEvents=function(t,e){var n,i=-1,s=t.length,r=e[0],c=e[1],l=e[2];switch(e.length){case 0:for(;++i<s;)(n=t[i]).callback.call(n.ctx);return;case 1:for(;++i<s;)(n=t[i]).callback.call(n.ctx,r);return;case 2:for(;++i<s;)(n=t[i]).callback.call(n.ctx,r,c);return;case 3:for(;++i<s;)(n=t[i]).callback.call(n.ctx,r,c,l);return;default:for(;++i<s;)(n=t[i]).callback.apply(n.ctx,e);return}},listenMethods={listenTo:"on",listenToOnce:"once"};_.each(listenMethods,function(t,e){Events[e]=function(e,n,i){var s=this._listeningTo||(this._listeningTo={}),r=e._listenId||(e._listenId=_.uniqueId("l"));return s[r]=e,i||"object"!=typeof n||(i=this),e[t](n,i,this),this}});
function addMethod(t,n,r){switch(t){case 1:return function(){return _[n](this[r])};case 2:return function(t){return _[n](this[r],t)};case 3:return function(t,e){return _[n](this[r],t,e)};case 4:return function(t,e,u){return _[n](this[r],t,e,u)};default:return function(){var t=slice.call(arguments);return t.unshift(this[r]),_[n].apply(_,t)}}}function addUnderscoreMethods(t,n,r){_.each(n,function(n,e){_[e]&&(t.prototype[e]=addMethod(n,e,r))})}
var Model=function(t,i){var e=t||{};i||(i={}),this.cid=_.uniqueId(this.cidPrefix),this.attributes={},i.collection&&(this.collection=i.collection),i.parse&&(e=this.parse(e,i)||{}),e=_.defaults({},e,_.result(this,"defaults")),this.set(e,i),this.changed={},this.initialize.apply(this,arguments)};_.extend(Model.prototype,Events,{changed:null,validationError:null,idAttribute:"id",cidPrefix:"c",initialize:function(){},toJSON:function(t){return _.clone(this.attributes)},sync:function(){return sync.apply(this,arguments)},get:function(t){return this.attributes[t]},escape:function(t){return _.escape(this.get(t))},has:function(t){return null!=this.get(t)},matches:function(t){return!!_.iteratee(t,this)(this.attributes)},set:function(t,i,e){var n,s,r,u,h,a,o,l;if(null==t)return this;if("object"==typeof t?(s=t,e=i):(s={})[t]=i,e||(e={}),!this._validate(s,e))return!1;r=e.unset,h=e.silent,u=[],a=this._changing,this._changing=!0,a||(this._previousAttributes=_.clone(this.attributes),this.changed={}),l=this.attributes,o=this._previousAttributes,this.idAttribute in s&&(this.id=s[this.idAttribute]);for(n in s)i=s[n],_.isEqual(l[n],i)||u.push(n),_.isEqual(o[n],i)?delete this.changed[n]:this.changed[n]=i,r?delete l[n]:l[n]=i;if(!h){u.length&&(this._pending=e);for(var c=0;c<u.length;c++)this.trigger("change:"+u[c],this,l[u[c]],e)}if(a)return this;if(!h)for(;this._pending;)e=this._pending,this._pending=!1,this.trigger("change",this,e);return this._pending=!1,this._changing=!1,this},unset:function(t,i){return this.set(t,void 0,_.extend({},i,{unset:!0}))},clear:function(t){var i={};for(var e in this.attributes)i[e]=void 0;return this.set(i,_.extend({},t,{unset:!0}))},hasChanged:function(t){return null==t?!_.isEmpty(this.changed):_.has(this.changed,t)},changedAttributes:function(t){if(!t)return this.hasChanged()?_.clone(this.changed):!1;var i,e=!1,n=this._changing?this._previousAttributes:this.attributes;for(var s in t)_.isEqual(n[s],i=t[s])||((e||(e={}))[s]=i);return e},previous:function(t){return null!=t&&this._previousAttributes?this._previousAttributes[t]:null},previousAttributes:function(){return _.clone(this._previousAttributes)},fetch:function(t){},save:function(t,i,e){},destroy:function(t){},url:function(){var t=_.result(this,"urlRoot")||_.result(this.collection,"url")||urlError();if(this.isNew())return t;var i=this.id||this.attributes[this.idAttribute];return t.replace(/([^\/])$/,"$1/")+encodeURIComponent(i)},parse:function(t,i){return t},clone:function(){return new this.constructor(this.attributes)},isNew:function(){return!this.has(this.idAttribute)},isValid:function(t){return this._validate({},_.extend(t||{},{validate:!0}))},_validate:function(t,i){if(!i.validate||!this.validate)return!0;t=_.extend({},this.attributes,t);var e=this.validationError=this.validate(t,i)||null;return e?(this.trigger("invalid",this,e,_.extend(i,{validationError:e})),!1):!0}});var modelMethods={keys:1,values:1,pairs:1,invert:1,pick:0,omit:0,chain:1,isEmpty:1};addUnderscoreMethods(Model,modelMethods,"attributes"),Model.extend=Collection.extend=extend;
var Restcase={Collection:Collection,Model:Model,Events:Events};
return Restcase.min;
}));
